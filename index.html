<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>땅따먹기 x BOJ (로컬)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121826;
      --panel2:#0f1522;
      --text:#e6edf3;
      --muted:#9fb0c0;
      --line:#243041;
      --accent:#4da3ff;
      --danger:#ff5a6a;
      --ok:#33d17a;
      --warn:#f2c94c;
      --chip:#1b2535;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --cell: 78px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #13213a 0%, var(--bg) 45%, #070a0f 100%);
      color:var(--text);
    }
    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      padding:18px;
      min-height:100vh;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd h1{
      font-size:15px; margin:0; letter-spacing:.2px;
    }
    .card .bd{ padding:14px; }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    label{font-size:12px; color:var(--muted);}
    input, select, button, textarea{
      font:inherit;
      color:var(--text);
    }
    input, select, textarea{
      background: rgba(0,0,0,.2);
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{ width:100%; min-height:120px; resize:vertical; }
    input::file-selector-button{
      background: var(--chip);
      border:1px solid var(--line);
      color:var(--text);
      border-radius: 10px;
      padding:8px 10px;
      margin-right:10px;
      cursor:pointer;
    }
    button{
      background: var(--chip);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      user-select:none;
    }
    button:hover{ background:#222f45; }
    button:active{ transform: translateY(1px); }
    .btn-accent{ border-color: rgba(77,163,255,.5); }
    .btn-danger{ border-color: rgba(255,90,106,.5); }
    .btn-ok{ border-color: rgba(51,209,122,.5); }
    .btn-small{ padding:8px 10px; border-radius:10px; font-size:13px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.4; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius: 999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .grid-wrap{
      padding:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(7, var(--cell));
      gap:10px;
      align-content:start;
      justify-content:start;
    }
    .cell{
      width:var(--cell);
      height:var(--cell);
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative;
      overflow:hidden;
    }
    .cell:hover{ border-color:#3a4b64; }
    .cell .pos{ font-size:11px; color:var(--muted); }
    .cell .owner{ font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cell .prob{ font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tag{
      position:absolute;
      top:8px; right:8px;
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--muted);
    }
    .tag.bronze{ border-color: rgba(205,127,50,.45); color:#cfa27a; }
    .tag.silver{ border-color: rgba(192,192,192,.45); color:#cfd6dd; }
    .tag.gold{ border-color: rgba(255,215,0,.45); color:#f6dc78; }
    .tag.platinum{ border-color: rgba(0,206,209,.45); color:#7fe7e8; }
    .tag.diamond{ border-color: rgba(185,242,255,.45); color:#b9f2ff; }
    .tag.ruby{ border-color: rgba(224,17,95,.45); color:#ff76ad; }
    .owner-none{ color: #8b9bb0; font-weight:600; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .log{
      max-height: 220px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    /* modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .hd{ padding:14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .modal .hd h2{ margin:0; font-size:15px; }
    .modal .bd{ padding:14px; }
    .modal .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .kv{ background: rgba(0,0,0,.18); border:1px solid var(--line); border-radius: 12px; padding:12px; }
    .kv .k{ font-size:11px; color:var(--muted); margin-bottom:6px;}
    .kv .v{ font-size:14px; font-weight:650; overflow-wrap:anywhere; }
    .warn{ color: var(--warn); }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .grid{ justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="hd">
        <h1>땅따먹기 x BOJ (로컬)</h1>
        <button class="btn-small btn-danger" id="btnReset">초기화</button>
      </div>
      <div class="bd">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">현재 플레이어</div>
            <select id="selPlayer" style="min-width:220px;"></select>
          </div>
          <div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">플레이어 추가</div>
            <div class="row">
              <input id="inpPlayer" placeholder="이름" style="width:180px;">
              <button class="btn-small btn-accent" id="btnAddPlayer">추가</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="gap:12px; align-items:flex-end;">
          <div style="flex:1; min-width:260px;">
            <label>문제셋 JSON 불러오기</label><br/>
            <input id="fileProblems" type="file" accept=".json,application/json" />
          </div>
          <button class="btn-ok" id="btnInitBoard">보드 7×7 새로 배정</button>
        </div>
        <div class="muted" style="margin-top:8px;">
          - 보드는 기본적으로 <b>Bronze</b> 문제로 시작합니다. 셀을 점령/빼앗을 때마다 다음 티어로 올라간 문제가 그 칸에 재배정됩니다.<br/>
          - 풀이 검증은 수작업(백준 검색)이고, 앱은 “클릭 + 확인 버튼”으로 상태만 관리합니다.
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between; gap:10px;">
          <div class="row">
            <button class="btn-small" id="btnExport">상태 내보내기(JSON)</button>
            <input id="fileImportState" type="file" accept=".json,application/json" />
          </div>
          <div class="chips" id="poolStatus"></div>
        </div>

        <div class="hr"></div>

        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">로그</div>
        <div class="log" id="logBox"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h1>보드</h1>
        <div class="chips">
          <span class="chip">클릭 → 상세 → “내가 풀었음”</span>
          <span class="chip">자동 저장(localStorage)</span>
        </div>
      </div>
      <div class="grid-wrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="hd">
        <h2 id="mdlTitle">셀</h2>
        <button class="btn-small" id="btnClose">닫기</button>
      </div>
      <div class="bd">
        <div class="modal grid2">
          <div class="kv">
            <div class="k">현재 소유자</div>
            <div class="v" id="mdlOwner"></div>
          </div>
          <div class="kv">
            <div class="k">현재 도전 문제(빼앗기용)</div>
            <div class="v" id="mdlProblem"></div>
            <div class="muted" id="mdlProblemLink" style="margin-top:6px;"></div>
          </div>
          <div class="kv">
            <div class="k">현재 티어</div>
            <div class="v" id="mdlTier"></div>
          </div>
          <div class="kv">
            <div class="k">다음 티어(점령 후 배정)</div>
            <div class="v" id="mdlNextTier"></div>
            <div class="muted" id="mdlPoolWarn" style="margin-top:6px;"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button class="btn-ok" id="btnSolved">내가 풀었음 (점령/빼앗기)</button>
            <button class="btn-small btn-danger" id="btnClearOwner">소유자 해제</button>
          </div>
          <div class="row">
            <button class="btn-small" id="btnManualEdit">수동 수정</button>
          </div>
        </div>

        <div id="manualBox" style="display:none; margin-top:12px;">
          <div class="hr"></div>
          <div class="row" style="gap:12px;">
            <div style="flex:1; min-width:200px;">
              <label>소유자</label><br/>
              <input id="inpManualOwner" placeholder="빈칸이면 무소유" style="width:100%;">
            </div>
            <div style="flex:1; min-width:200px;">
              <label>티어</label><br/>
              <select id="selManualTier" style="width:100%;"></select>
            </div>
          </div>
          <div class="row" style="margin-top:10px; gap:12px;">
            <div style="flex:1; min-width:200px;">
              <label>문제 번호</label><br/>
              <input id="inpManualPid" placeholder="예: 1000" style="width:100%;">
            </div>
            <div style="flex:1; min-width:200px;">
              <label>문제 제목(선택)</label><br/>
              <input id="inpManualTitle" placeholder="예: A+B" style="width:100%;">
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:10px;">
            <button class="btn-accent" id="btnApplyManual">적용</button>
          </div>
        </div>

        <div class="hr"></div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">이 칸 점령/빼앗기 히스토리</div>
        <div class="log" id="mdlHistory"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "ddm_boj_territory_v1";

  // 티어는 확장 가능. (요청 예시는 Bronze->Silver->Gold)
  const TIERS = ["Bronze","Silver","Gold","Platinum","Diamond","Ruby"];
  const TIER_CLASS = { Bronze:"bronze", Silver:"silver", Gold:"gold", Platinum:"platinum", Diamond:"diamond", Ruby:"ruby" };

  const $ = (id) => document.getElementById(id);

  const state = {
    players: ["우인"],          // 기본값 (원하면 삭제 가능)
    currentPlayer: "우인",
    size: 7,
    problems: {},              // {tier: [{id,title?}, ...]}
    used: {},                  // {tier: Set(id)} (직렬화 위해 배열로 저장/복구)
    board: [],                 // length size*size
    log: []
  };

  function nowStr(){
    const d = new Date();
    const pad = (x)=>String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function pushLog(msg){
    state.log.unshift(`[${nowStr()}] ${msg}`);
    if(state.log.length > 200) state.log.pop();
    renderLog();
    save();
  }

  function save(){
    const plain = structuredClone(state);
    // Set 직렬화
    const usedPlain = {};
    for(const t of TIERS){
      usedPlain[t] = Array.from((state.used[t] || new Set()).values());
    }
    plain.used = usedPlain;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(plain));
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    try{
      const obj = JSON.parse(raw);

      // 기본 병합
      state.players = Array.isArray(obj.players) ? obj.players : state.players;
      state.currentPlayer = obj.currentPlayer || state.players[0] || "Player";
      state.size = obj.size || 7;

      state.problems = obj.problems || {};
      state.used = {};
      for(const t of TIERS){
        state.used[t] = new Set((obj.used && obj.used[t]) ? obj.used[t] : []);
      }
      state.board = Array.isArray(obj.board) ? obj.board : [];
      state.log = Array.isArray(obj.log) ? obj.log : [];
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }

  function normalizeProblems(probObj){
    const out = {};
    for(const t of TIERS){
      const arr = Array.isArray(probObj?.[t]) ? probObj[t] : [];
      out[t] = arr
        .filter(x => x && (x.id !== undefined))
        .map(x => ({ id: Number(x.id), title: x.title ? String(x.title) : "" }))
        .filter(x => Number.isFinite(x.id) && x.id > 0);
    }
    return out;
  }

  async function autoLoadProblemsIfExists(){
  // 이미 문제셋이 로딩돼 있으면 다시 안 읽음 (수동 업로드도 계속 가능)
  if(state.problems && Object.keys(state.problems).length) return;

  try{
    const r = await fetch("problems.json", { cache: "no-store" });
    if(!r.ok) return;

    const obj = await r.json();
    state.problems = normalizeProblems(obj);

    // used 보정
    for(const t of TIERS){
      if(!state.used[t]) state.used[t] = new Set();
    }

    pushLog("problems.json 자동 로드 완료");
    renderPoolStatus();
    save();
  }catch(e){
    // problems.json이 없거나 JSON 파싱 에러면 그냥 무시 (수동 업로드로 진행)
  }
}


  function poolRemaining(tier){
    const pool = state.problems[tier] || [];
    const used = state.used[tier] || new Set();
    return pool.filter(p => !used.has(p.id));
  }

  function drawProblem(tier){
    const pool = state.problems[tier] || [];
    if(!state.used[tier]) state.used[tier] = new Set();

    let candidates = poolRemaining(tier);
    let recycled = false;

    if(candidates.length === 0 && pool.length > 0){
      // 다 썼으면 재사용 허용
      recycled = true;
      candidates = pool.slice();
      state.used[tier].clear();
    }

    if(candidates.length === 0){
      // 풀 자체가 비었으면 dummy
      return { problem: { id: 0, title: "(문제셋 없음)" }, recycled: true, empty: true };
    }

    const pick = candidates[Math.floor(Math.random() * candidates.length)];
    state.used[tier].add(pick.id);
    return { problem: pick, recycled, empty: false };
  }

  function makeEmptyCell(idx){
    // 시작 티어: Bronze
    const tierIndex = 0;
    const tier = TIERS[tierIndex];
    const { problem, recycled, empty } = drawProblem(tier);
    return {
      idx,
      owner: null,
      tierIndex,
      tier,
      problem,
      history: [],
      meta: { recycled, empty }
    };
  }

  function initBoard(){
    if(!state.problems || Object.keys(state.problems).length === 0){
      alert("먼저 문제셋 JSON을 불러와주세요.");
      return;
    }

    // used 초기화 (새 게임이면 중복 없는 랜덤 배정 위해)
    state.used = {};
    for(const t of TIERS) state.used[t] = new Set();

    state.board = [];
    for(let i=0;i<state.size*state.size;i++){
      state.board.push(makeEmptyCell(i));
    }
    pushLog(`보드 ${state.size}×${state.size} 새로 생성(초기 티어: Bronze)`);
    renderAll();
    save();
  }

  function tierName(t){ return t; }

  function nextTier(cell){
    const ni = Math.min(cell.tierIndex + 1, TIERS.length - 1);
    return TIERS[ni];
  }

  function formatProblem(p){
    if(!p || !p.id) return "(문제 없음)";
    return p.title ? `${p.id} - ${p.title}` : `${p.id}`;
  }

  function bojLink(pid){
    if(!pid) return "";
    return `https://www.acmicpc.net/problem/${pid}`;
  }

  function renderPlayers(){
    const sel = $("selPlayer");
    sel.innerHTML = "";
    for(const name of state.players){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }
    if(!state.players.includes(state.currentPlayer)){
      state.currentPlayer = state.players[0] || "Player";
    }
    sel.value = state.currentPlayer;
  }

  function renderPoolStatus(){
    const wrap = $("poolStatus");
    wrap.innerHTML = "";
    for(const t of TIERS){
      const pool = state.problems[t] || [];
      const used = state.used[t] || new Set();
      const rem = pool.filter(p => !used.has(p.id)).length;
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = `${t}: ${rem}/${pool.length}`;
      wrap.appendChild(chip);
    }
  }

  function renderLog(){
    $("logBox").textContent = state.log.join("\n") || "(로그 없음)";
  }

  function cellLabel(i){
    // 0..48 => (r,c)
    const r = Math.floor(i / state.size);
    const c = i % state.size;
    return `${r+1}-${c+1}`;
  }

  function renderBoard(){
    const grid = $("grid");
    grid.innerHTML = "";

    for(let i=0;i<state.size*state.size;i++){
      const cell = state.board[i];
      const div = document.createElement("div");
      div.className = "cell";
      div.dataset.idx = i;

      const tag = document.createElement("div");
      tag.className = `tag ${TIER_CLASS[cell.tier] || ""}`;
      tag.textContent = cell.tier;
      div.appendChild(tag);

      const top = document.createElement("div");
      top.className = "pos";
      top.textContent = cellLabel(i);
      div.appendChild(top);

      const mid = document.createElement("div");
      mid.className = "owner";
      if(cell.owner){
        mid.textContent = cell.owner;
      }else{
        mid.textContent = "무소유";
        mid.classList.add("owner-none");
      }
      div.appendChild(mid);

      const bot = document.createElement("div");
      bot.className = "prob";
      bot.textContent = formatProblem(cell.problem);
      div.appendChild(bot);

      div.addEventListener("click", () => openModal(i));
      grid.appendChild(div);
    }
  }

  // modal controls
  let modalIdx = null;

  function openModal(i){
    modalIdx = i;
    const cell = state.board[i];
    $("mdlTitle").textContent = `칸 ${cellLabel(i)}`;
    $("mdlOwner").textContent = cell.owner || "무소유";

    $("mdlTier").textContent = tierName(cell.tier);

    const ptxt = formatProblem(cell.problem);
    $("mdlProblem").textContent = ptxt;

    const link = bojLink(cell.problem?.id);
    $("mdlProblemLink").innerHTML = link
      ? `백준 링크: <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`
      : "";

    const nt = nextTier(cell);
    $("mdlNextTier").textContent = tierName(nt);

    // pool warning
    const pool = state.problems[nt] || [];
    const rem = poolRemaining(nt).length;
    let warn = "";
    if(pool.length === 0){
      warn = "⚠️ 다음 티어 문제셋이 비어있습니다. (점령 후 '(문제셋 없음)' 배정)";
    }else if(rem === 0){
      warn = "⚠️ 다음 티어 미사용 문제가 없습니다. (재사용 모드로 배정)";
    }
    $("mdlPoolWarn").textContent = warn;

    // history
    const h = (cell.history || []).slice().reverse();
    $("mdlHistory").textContent = h.length
      ? h.map(x => `${x.time} | ${x.player} 점령 (해결: ${formatProblem(x.solved)}) → 다음: ${x.nextTier} ${formatProblem(x.nextProblem)}`).join("\n")
      : "(히스토리 없음)";

    // manual edit preset
    $("manualBox").style.display = "none";
    $("inpManualOwner").value = cell.owner || "";
    $("selManualTier").value = cell.tier;
    $("inpManualPid").value = cell.problem?.id ? String(cell.problem.id) : "";
    $("inpManualTitle").value = cell.problem?.title || "";

    $("backdrop").style.display = "flex";
  }

  function closeModal(){
    $("backdrop").style.display = "none";
    modalIdx = null;
  }

  function claimSolved(){
    if(modalIdx === null) return;
    const cell = state.board[modalIdx];
    const player = state.currentPlayer;

    const solved = cell.problem || { id:0, title:"" };
    const oldOwner = cell.owner || "무소유";

    // 점령 처리
    cell.owner = player;

    // 난이도 상승 + 다음 문제 배정
    const ni = Math.min(cell.tierIndex + 1, TIERS.length - 1);
    const nt = TIERS[ni];
    const draw = drawProblem(nt);

    cell.tierIndex = ni;
    cell.tier = nt;
    const nextProblem = draw.problem;
    cell.problem = nextProblem;
    cell.meta = { recycled: draw.recycled, empty: draw.empty };

    // history
    cell.history = cell.history || [];
    cell.history.push({
      time: nowStr(),
      player,
      fromOwner: oldOwner,
      solved: solved,
      nextTier: nt,
      nextProblem: nextProblem
    });

    pushLog(`${player}가 칸 ${cellLabel(modalIdx)} 점령/빼앗기 (이전: ${oldOwner}, 해결: ${formatProblem(solved)}) → 다음 문제: ${nt} ${formatProblem(nextProblem)}`);
    renderAll();
    openModal(modalIdx); // 갱신된 정보로 다시 렌더
    save();
  }

  function clearOwner(){
    if(modalIdx === null) return;
    const cell = state.board[modalIdx];
    const old = cell.owner;
    cell.owner = null;
    pushLog(`칸 ${cellLabel(modalIdx)} 소유자 해제 (이전 소유자: ${old || "무소유"})`);
    renderAll();
    openModal(modalIdx);
    save();
  }

  function toggleManual(){
    const box = $("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  function applyManual(){
    if(modalIdx === null) return;
    const cell = state.board[modalIdx];

    const owner = $("inpManualOwner").value.trim();
    const tier = $("selManualTier").value;
    const pid = Number($("inpManualPid").value.trim() || 0);
    const title = $("inpManualTitle").value.trim();

    cell.owner = owner ? owner : null;
    cell.tier = tier;
    cell.tierIndex = Math.max(0, TIERS.indexOf(tier));
    cell.problem = { id: pid, title: title };

    pushLog(`칸 ${cellLabel(modalIdx)} 수동 수정 (owner=${cell.owner||"무소유"}, tier=${tier}, problem=${formatProblem(cell.problem)})`);
    renderAll();
    openModal(modalIdx);
    save();
  }

  function renderAll(){
    renderPlayers();
    renderPoolStatus();
    renderLog();
    renderBoard();
  }

  // Export / Import state
  function exportState(){
    save();
    const raw = localStorage.getItem(STORAGE_KEY) || JSON.stringify(state);
    const blob = new Blob([raw], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "territory_state.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importStateFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result || ""));
        // localStorage를 통한 load 로직과 동일하게 적용
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        load();
        pushLog("상태 JSON 불러오기 완료");
        renderAll();
      }catch(e){
        alert("상태 파일 JSON 파싱 실패");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function importProblemsFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result || ""));
        state.problems = normalizeProblems(obj);

        // used 구조 보정
        for(const t of TIERS){
          if(!state.used[t]) state.used[t] = new Set();
        }

        pushLog("문제셋 JSON 불러오기 완료");
        renderPoolStatus();
        save();
      }catch(e){
        console.error(e);
        alert("문제셋 파일 JSON 파싱 실패");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function hardReset(){
    if(!confirm("정말 초기화할까요? (보드/로그/저장 데이터가 삭제됩니다)")) return;
    localStorage.removeItem(STORAGE_KEY);

    state.players = ["우인"];
    state.currentPlayer = "우인";
    state.size = 7;
    state.problems = {};
    state.used = {};
    for(const t of TIERS) state.used[t] = new Set();
    state.board = [];
    state.log = [];

    renderAll();
  }

  // init
  async function boot(){
    // manual tier select
    const sel = $("selManualTier");
    sel.innerHTML = "";
    for(const t of TIERS){
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      sel.appendChild(opt);
    }

    const loaded = load();
    await autoLoadProblemsIfExists();
    
    if(!loaded){
      // 기본 used 초기화
      for(const t of TIERS) state.used[t] = new Set();
      pushLog("새 세션 시작");
      save();
    }

    renderAll();

    // listeners
    $("btnAddPlayer").addEventListener("click", () => {
      const v = $("inpPlayer").value.trim();
      if(!v) return;
      if(state.players.includes(v)){
        alert("이미 존재하는 플레이어입니다.");
        return;
      }
      state.players.push(v);
      state.currentPlayer = v;
      $("inpPlayer").value = "";
      pushLog(`플레이어 추가: ${v}`);
      renderPlayers();
      save();
    });

    $("selPlayer").addEventListener("change", (e) => {
      state.currentPlayer = e.target.value;
      save();
    });

    $("fileProblems").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if(f) importProblemsFile(f);
      e.target.value = "";
    });

    $("btnInitBoard").addEventListener("click", initBoard);

    $("btnExport").addEventListener("click", exportState);
    $("fileImportState").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if(f) importStateFile(f);
      e.target.value = "";
    });

    $("btnReset").addEventListener("click", hardReset);

    $("btnClose").addEventListener("click", closeModal);
    $("backdrop").addEventListener("click", (e) => {
      if(e.target === $("backdrop")) closeModal();
    });

    $("btnSolved").addEventListener("click", () => {
      if(!confirm("정말 '내가 풀었음'으로 처리할까요? (점령/빼앗기 + 다음 티어 문제 배정)")) return;
      claimSolved();
    });
    $("btnClearOwner").addEventListener("click", clearOwner);
    $("btnManualEdit").addEventListener("click", toggleManual);
    $("btnApplyManual").addEventListener("click", applyManual);

    // ESC close
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeModal();
    });
  }

  boot();
})();
</script>
</body>
</html>

